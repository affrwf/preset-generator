<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Warface Preset Generator (Client-only)</title>
  <style>
    /* ======== Ваши стили ======== */
    body {
      margin: 0; 
      font-family: Arial, sans-serif;
      background: #222; 
      color: #eee;
    }
    header {
      background: linear-gradient(135deg, #512DA8, #673AB7);
      padding: 1rem;
      text-align: center;
    }
    h1 { margin: 0; }
    .container {
      max-width: 900px;
      margin: 2rem auto;
      background: #333;
      padding: 1rem;
      border-radius: 8px;
    }
    .form-group { margin-bottom: 1rem; }
    label {
      display: block; 
      margin-bottom: 0.5rem; 
      font-weight: bold;
    }
    select {
      width: 100%; 
      padding: 0.5rem;
      border-radius: 4px;
      border: none;
      background: #444;
      color: #fff;
    }
    .btn {
      padding: 0.6rem 1.2rem;
      background: #673AB7;
      border: none;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-top: 0.5rem;
    }
    .btn:hover { background: #7E57C2; }
    #resultArea {
      width: 100%;
      height: 250px;
      margin-top: 1rem;
      background: #1e1e1e;
      color: #c4ffb5;
      border: none;
      border-radius: 5px;
      padding: 0.5rem;
      font-family: monospace;
      resize: vertical;
    }
    footer {
      text-align: center; 
      padding: 1rem;
      font-size: 0.9rem;
      color: #999;
    }
    .hidden { display: none; }
  </style>
</head>
<body>

<header>
  <h1>Генератор пресетов Warface (Client-only)</h1>
</header>

<div class="container">

  <!-- Блок прогресса, показываем "загрузка..." пока подгружаем XML -->
  <div id="loadingBlock">
    <p>Загрузка XML-файлов...</p>
  </div>

  <!-- Основной UI (спрятан, пока не загрузим данные) -->
  <div id="mainUI" class="hidden">
    <div class="form-group">
      <label for="classSelect">Выберите класс:</label>
      <select id="classSelect">
        <option value="assault">Штурмовик</option>
        <option value="medic">Медик</option>
        <option value="engineer">Инженер</option>
        <option value="sniper">Снайпер</option>
      </select>
    </div>
    <button class="btn" id="generateBtn">Сгенерировать</button>
    <textarea id="resultArea" readonly></textarea>
    <div>
      <button class="btn" id="copyBtn">Скопировать</button>
      <button class="btn" id="downloadBtn">Скачать</button>
    </div>
  </div>

</div>

<footer>
  &copy; 2024 Warface Preset Generator. Размещён на GitHub Pages.
</footer>

<script>
/* ============= 1) Настраиваем список файлов ============= */
const WEAPONS_FILES = [
  "ar01.xml",
  "ar02.xml",
  "pt35.xml",
  "kn01.xml"
  // ... добавьте все нужные
];

const SKINS_FILES = [
  "engineer_fbs_01.xml",
  "default_gunner_skin.xml"
  // ... добавьте все нужные
];

/* ============= 2) Глобальные массивы ============= */
let allWeapons = [];
let allSkins = [];

/* ============= 3) Утилита parseXmlString ============= */
function parseXmlString(xmlStr) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(xmlStr, "application/xml");
  return doc;
}

/* ============= 4) Загрузка + парсинг оружия ============= */
async function loadWeapon(fileName) {
  const url = `data/weapons/${fileName}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error("Не удалось загрузить " + url);
  const text = await resp.text();
  const xmlDoc = parseXmlString(text);

  const item = xmlDoc.getElementsByTagName("item")[0];
  if (!item) {
    console.warn(`Файл ${fileName}: не найден <item>`);
    return null;
  }

  const weaponName = item.getAttribute("name") || "unknown_weapon";

  // ammo_type
  let ammoType = "unknown_ammo";
  const fireparams = item.getElementsByTagName("fireparams")[0];
  if (fireparams) {
    const fire = fireparams.getElementsByTagName("fire")[0];
    if (fire) {
      const params = [...fire.getElementsByTagName("param")];
      const ammoParam = params.find(p => p.getAttribute("name") === "ammo_type");
      if (ammoParam) {
        ammoType = ammoParam.getAttribute("value") || "unknown_ammo";
      }
    }
  }

  // attachments
  let attachments = [];
  const sockets = item.getElementsByTagName("sockets")[0];
  if (sockets) {
    const socketList = [...sockets.getElementsByTagName("socket")];
    socketList.forEach(socket => {
      const supports = [...socket.getElementsByTagName("support")];
      supports.forEach(s => {
        const attName = s.getAttribute("name");
        if (attName) attachments.push(attName);
      });
    });
  }

  // Тип оружия (ar, pt, shg, smg, sr, kn...) по имени
  let weaponType = "other";
  if (weaponName.startsWith("ar"))  weaponType = "ar";
  else if (weaponName.startsWith("shg")) weaponType = "shg";
  else if (weaponName.startsWith("smg")) weaponType = "smg";
  else if (weaponName.startsWith("sr"))  weaponType = "sr";
  else if (weaponName.startsWith("pt"))  weaponType = "pt";
  else if (weaponName.startsWith("kn"))  weaponType = "kn";

  return {
    name: weaponName,
    type: weaponType,
    ammo_type: ammoType,
    attachments
  };
}

/* ============= 5) Загрузка + парсинг скина ============= */
async function loadSkin(fileName) {
  const url = `data/skins/${fileName}`;
  const resp = await fetch(url);
  if (!resp.ok) throw new Error("Не удалось загрузить " + url);
  const text = await resp.text();
  const xmlDoc = parseXmlString(text);

  const gameItem = xmlDoc.getElementsByTagName("GameItem")[0];
  if (!gameItem) {
    console.warn(`Файл ${fileName}: не найден <GameItem>`);
    return null;
  }

  const skinName = gameItem.getAttribute("name") || "unknown_skin";

  // classes из <mmo_stats><param name="classes" value="E"/>
  let classesList = [];
  const mmoStats = xmlDoc.getElementsByTagName("mmo_stats")[0];
  if (mmoStats) {
    const params = [...mmoStats.getElementsByTagName("param")];
    const classesParam = params.find(p => p.getAttribute("name") === "classes");
    if (classesParam) {
      const val = classesParam.getAttribute("value") || "";
      classesList = val
        .split(",")
        .map(c => c.trim())
        .filter(Boolean);
    }
  }

  // Пропускаем, если есть 'REMSH' или пусто
  if (classesList.includes("REMSH") || classesList.length === 0) {
    return null;
  }

  return {
    name: skinName,
    classes: classesList
  };
}

/* ============= 6) Загрузка всего ============= */
async function loadAllData() {
  // 1. Оружие
  const weaponPromises = WEAPONS_FILES.map(f => loadWeapon(f));
  const weaponsResults = await Promise.all(weaponPromises);
  allWeapons = weaponsResults.filter(Boolean);

  // 2. Скины
  const skinPromises = SKINS_FILES.map(f => loadSkin(f));
  const skinsResults = await Promise.all(skinPromises);
  allSkins = skinsResults.filter(Boolean);
}

/* ============= 7) Генерация пресета ============= */
const CLASS_WEAPON_MAP = {
  assault:  ["ar", "pt", "kn"],
  medic:    ["shg", "pt", "kn"],
  engineer: ["smg", "pt", "kn"],
  sniper:   ["sr", "pt", "kn"]
};
const CLASS_CODE_MAP = {
  assault:  "R",
  medic:    "M",
  engineer: "E",
  sniper:   "S"
};
const DEFAULT_ARMOR = [
  {name: "shared_jacket_02"},
  {name: "shared_pants_02"},
  {name: "sniper_helmet_frontlines01"},
  {name: "sniper_vest_frontlines01"},
  {name: "sniper_hands_frontlines01"},
  {name: "sniper_shoes_frontlines01"}
];

function generatePreset(selectedClass) {
  const neededTypes = CLASS_WEAPON_MAP[selectedClass];
  if (!neededTypes) return null;

  // Оружие
  const chosenWeapons = neededTypes.map(type => {
    const candidates = allWeapons.filter(w => w.type === type);
    if (candidates.length === 0) return null;
    const randIndex = Math.floor(Math.random() * candidates.length);
    return candidates[randIndex];
  }).filter(Boolean);

  // attachments + ammo
  let attachments = [];
  let ammo = [];
  for (const w of chosenWeapons) {
    if (!w) continue;
    for (const att of w.attachments) {
      attachments.push({ name: att, attachTo: w.name });
    }
    if (w.ammo_type && w.ammo_type !== "unknown_ammo") {
      ammo.push({ name: w.ammo_type, amount: 999 });
    }
  }
  // Удаляем дубли патронов
  const ammoMap = {};
  for (const a of ammo) {
    ammoMap[a.name] = a;
  }
  ammo = Object.values(ammoMap);

  // Скин
  const classCode = CLASS_CODE_MAP[selectedClass];
  const possibleSkins = allSkins.filter(s => s.classes.includes(classCode));
  let chosenSkin = "default_skin_unknown";
  if (possibleSkins.length > 0) {
    const idx = Math.floor(Math.random() * possibleSkins.length);
    chosenSkin = possibleSkins[idx].name;
  }

  // Финальная броня + скин
  const finalArmor = [...DEFAULT_ARMOR];
  finalArmor.push({ name: chosenSkin });

  return {
    armor: finalArmor,
    items: chosenWeapons.map(w => ({ name: w.name, skin: "" })),
    attachments,
    ammo
  };
}

/* ============= 8) Форматирование в Lua ============= */
function formatLua(inventory) {
  const armorStr = inventory.armor
    .map(a => `      {name = "${a.name}"}`)
    .join(",\n");

  const itemsStr = inventory.items
    .map(i => `      {name = "${i.name}", skin = "${i.skin}"}`)
    .join(",\n");

  const attachmentsStr = inventory.attachments
    .map(a => `      {name = "${a.name}", attachTo = "${a.attachTo}"}`)
    .join(",\n");

  const ammoStr = inventory.ammo
    .map(a => `      {name = "${a.name}", amount = ${a.amount}}`)
    .join(",\n");

  return `
local inventory = {
  armor = 
  {
${armorStr}
  },
  items = 
  {
${itemsStr}
  },
  attachments = 
  {
${attachmentsStr}
  },
  ammo = 
  {
${ammoStr}
  }
}
return inventory
`.trim();
}

/* ============= 9) Инициализация при загрузке страницы ============= */
window.addEventListener("DOMContentLoaded", async () => {
  const loadingBlock = document.getElementById("loadingBlock");
  const mainUI = document.getElementById("mainUI");
  const classSelect = document.getElementById("classSelect");
  const generateBtn = document.getElementById("generateBtn");
  const resultArea = document.getElementById("resultArea");
  const copyBtn = document.getElementById("copyBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  try {
    // Загружаем все XML
    await loadAllData();

    // Спрячем блок "Загрузка", покажем UI
    loadingBlock.classList.add("hidden");
    mainUI.classList.remove("hidden");

    generateBtn.addEventListener("click", () => {
      const selectedClass = classSelect.value;
      const inv = generatePreset(selectedClass);
      if (!inv) {
        resultArea.value = "Ошибка: неизвестный класс или нет данных.";
        return;
      }
      resultArea.value = formatLua(inv);
    });

    copyBtn.addEventListener("click", () => {
      if (!resultArea.value) return;
      navigator.clipboard.writeText(resultArea.value)
        .then(() => alert("Скопировано!"))
        .catch(err => console.error(err));
    });

    downloadBtn.addEventListener("click", () => {
      if (!resultArea.value) return;
      const blob = new Blob([resultArea.value], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "preset.lua";
      link.click();
      URL.revokeObjectURL(url);
    });

  } catch (err) {
    loadingBlock.textContent = "Ошибка при загрузке: " + err.message;
    console.error(err);
  }
});
</script>

</body>
</html>
