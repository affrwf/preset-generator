<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Warface Preset Generator (GitHub Pages)</title>
  <style>
    /* ===== CSS ===== */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #222;
      color: #eee;
    }
    header {
      background: linear-gradient(135deg, #512DA8, #673AB7);
      padding: 1rem;
      text-align: center;
    }
    h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    .container {
      max-width: 900px;
      margin: 2rem auto;
      background: #333;
      padding: 1rem;
      border-radius: 8px;
    }
    label { font-weight: bold; display: block; margin-bottom: 0.4rem; }
    select, button {
      padding: 0.5rem;
      border-radius: 4px;
      border: none;
    }
    select { width: 100%; background: #444; color: #fff; }
    .btn {
      background: #673AB7;
      color: #fff;
      cursor: pointer;
      margin-top: 0.5rem;
      margin-right: 0.5rem;
    }
    .btn:hover { background: #7E57C2; }
    #resultArea {
      width: 100%;
      height: 250px;
      margin-top: 1rem;
      background: #1e1e1e;
      color: #c4ffb5;
      border: none;
      border-radius: 5px;
      padding: 0.5rem;
      font-family: monospace;
      resize: vertical;
    }
    #loadingBlock {
      text-align: center;
      margin-bottom: 1rem;
    }
    footer {
      text-align: center;
      padding: 1rem;
      font-size: 0.9rem;
      color: #999;
    }
    .hidden { display: none; }
  </style>
</head>
<body>

<header>
  <h1>Генератор пресетов Warface (GitHub Pages)</h1>
</header>

<div class="container">

  <div id="loadingBlock">
    <p>Загружаем списки файлов (JSON)...</p>
  </div>

  <div id="mainUI" class="hidden">
    <div>
      <label for="classSelect">Выберите класс:</label>
      <select id="classSelect">
        <option value="assault">Штурмовик</option>
        <option value="medic">Медик</option>
        <option value="engineer">Инженер</option>
        <option value="sniper">Снайпер</option>
      </select>
    </div>
    <button class="btn" id="generateBtn">Сгенерировать</button>

    <textarea id="resultArea" readonly></textarea>
    <div>
      <button class="btn" id="copyBtn">Скопировать</button>
      <button class="btn" id="downloadBtn">Скачать</button>
    </div>
  </div>

</div>

<footer>
  &copy; 2024 Warface Preset Generator (GitHub Pages)
</footer>

<script>
/* =========== 1) Настройки путей =========== */
const WEAPONS_JSON_URL = "weapons.json";
const SKINS_JSON_URL   = "skins.json";

// Папки, где лежат XML
const WEAPONS_FOLDER = "data/weapons/";
const SKINS_FOLDER   = "data/skins/";

/* =========== 2) Глобальные массивы данных =========== */
let allWeapons = [];
let allSkins = [];

/* =========== 3) Утилита parseXmlString =========== */
function parseXmlString(xmlStr) {
  const parser = new DOMParser();
  return parser.parseFromString(xmlStr, "application/xml");
}

/* =========== 4) Функции для парсинга отдельных XML-файлов =========== */
function parseWeaponXml(xmlDoc, fileName) {
  // Предположим, что корневой тэг: <item name="ar01" ...>
  const item = xmlDoc.getElementsByTagName("item")[0];
  if (!item) {
    console.warn(`Нет <item> в файле: ${fileName}`);
    return null;
  }
  const weaponName = item.getAttribute("name") || "unknown_weapon";

  // ammo_type (ищем в <fireparams><fire><param name="ammo_type" value="..."/>)
  let ammoType = "unknown_ammo";
  const fireparams = item.getElementsByTagName("fireparams")[0];
  if (fireparams) {
    const fire = fireparams.getElementsByTagName("fire")[0];
    if (fire) {
      const paramList = fire.getElementsByTagName("param");
      for (const p of paramList) {
        if (p.getAttribute("name") === "ammo_type") {
          ammoType = p.getAttribute("value") || "unknown_ammo";
          break;
        }
      }
    }
  }

  // attachments
  let attachments = [];
  const sockets = item.getElementsByTagName("sockets")[0];
  if (sockets) {
    const socketList = sockets.getElementsByTagName("socket");
    for (const socket of socketList) {
      const supportList = socket.getElementsByTagName("support");
      for (const s of supportList) {
        const attName = s.getAttribute("name");
        if (attName) attachments.push(attName);
      }
    }
  }

  // Определяем тип (ar, shg, smg, sr, pt, kn...) по имени
  let weaponType = "other";
  if (weaponName.startsWith("ar"))  weaponType = "ar";
  else if (weaponName.startsWith("shg")) weaponType = "shg";
  else if (weaponName.startsWith("smg")) weaponType = "smg";
  else if (weaponName.startsWith("sr"))  weaponType = "sr";
  else if (weaponName.startsWith("pt"))  weaponType = "pt";
  else if (weaponName.startsWith("kn"))  weaponType = "kn";

  return {
    name: weaponName,
    type: weaponType,
    ammo_type: ammoType,
    attachments
  };
}

function parseSkinXml(xmlDoc, fileName) {
  // Предположим, что корневой тэг: <GameItem name="engineer_fbs_01" ...>
  const gameItem = xmlDoc.getElementsByTagName("GameItem")[0];
  if (!gameItem) {
    console.warn(`Нет <GameItem> в файле: ${fileName}`);
    return null;
  }
  const skinName = gameItem.getAttribute("name") || "unknown_skin";

  // classes ищем в <mmo_stats><param name="classes" value="E" />
  let classesList = [];
  const mmoStats = xmlDoc.getElementsByTagName("mmo_stats")[0];
  if (mmoStats) {
    const paramList = mmoStats.getElementsByTagName("param");
    for (const p of paramList) {
      if (p.getAttribute("name") === "classes") {
        const val = p.getAttribute("value") || "";
        classesList = val.split(",").map(x => x.trim()).filter(Boolean);
        break;
      }
    }
  }

  // Пропускаем, если есть 'REMSH' или пусто
  if (classesList.includes("REMSH") || classesList.length === 0) {
    return null;
  }

  return {
    name: skinName,
    classes: classesList
  };
}

/* =========== 5) Основная функция для загрузки всех файлов =========== */
async function loadAllData() {
  // 5.1 Сначала загружаем JSON со списком weapon-файлов
  const weaponsListResp = await fetch(WEAPONS_JSON_URL);
  if (!weaponsListResp.ok) throw new Error("Не удалось загрузить " + WEAPONS_JSON_URL);
  const weaponsList = await weaponsListResp.json(); // массив строк

  // 5.2 Сначала загружаем JSON со списком skin-файлов
  const skinsListResp = await fetch(SKINS_JSON_URL);
  if (!skinsListResp.ok) throw new Error("Не удалось загрузить " + SKINS_JSON_URL);
  const skinsList = await skinsListResp.json(); // массив строк

  // 5.3 Загружаем все weapon-XML
  let weaponPromises = weaponsList.map(async fileName => {
    const url = WEAPONS_FOLDER + fileName; // "data/weapons/ar01.xml"
    const resp = await fetch(url);
    if (!resp.ok) {
      console.warn("Не удалось fetch-нуть", url);
      return null;
    }
    const text = await resp.text();
    const xmlDoc = parseXmlString(text);
    const weaponObj = parseWeaponXml(xmlDoc, fileName);
    return weaponObj;
  });

  let weaponsRaw = await Promise.all(weaponPromises);
  allWeapons = weaponsRaw.filter(Boolean);

  // 5.4 Загружаем все skin-XML
  let skinPromises = skinsList.map(async fileName => {
    const url = SKINS_FOLDER + fileName; // "data/skins/engineer_fbs_01.xml"
    const resp = await fetch(url);
    if (!resp.ok) {
      console.warn("Не удалось fetch-нуть", url);
      return null;
    }
    const text = await resp.text();
    const xmlDoc = parseXmlString(text);
    const skinObj = parseSkinXml(xmlDoc, fileName);
    return skinObj;
  });

  let skinsRaw = await Promise.all(skinPromises);
  allSkins = skinsRaw.filter(Boolean);
}

/* =========== 6) Генерация пресета =========== */

// Класс → какие типы оружия
const CLASS_WEAPON_MAP = {
  assault:  ["ar", "pt", "kn"],
  medic:    ["shg", "pt", "kn"],
  engineer: ["smg", "pt", "kn"],
  sniper:   ["sr", "pt", "kn"]
};

// Класс → код (R, M, E, S)
const CLASS_CODE_MAP = {
  assault:  "R",
  medic:    "M",
  engineer: "E",
  sniper:   "S"
};

// Базовая экипировка без скина
const DEFAULT_ARMOR = [
  { name: "shared_jacket_02" },
  { name: "shared_pants_02" },
  { name: "sniper_helmet_frontlines01" },
  { name: "sniper_vest_frontlines01" },
  { name: "sniper_hands_frontlines01" },
  { name: "sniper_shoes_frontlines01" }
];

function generatePreset(selectedClass) {
  const neededTypes = CLASS_WEAPON_MAP[selectedClass];
  if (!neededTypes) return null;

  // Рандомно выбираем оружие
  const chosenWeapons = neededTypes.map(type => {
    const candidates = allWeapons.filter(w => w.type === type);
    if (candidates.length === 0) return null;
    const randIndex = Math.floor(Math.random() * candidates.length);
    return candidates[randIndex];
  }).filter(Boolean);

  // attachments + ammo
  let attachments = [];
  let ammo = [];
  for (const w of chosenWeapons) {
    if (!w) continue;
    for (const att of w.attachments) {
      attachments.push({ name: att, attachTo: w.name });
    }
    if (w.ammo_type && w.ammo_type !== "unknown_ammo") {
      ammo.push({ name: w.ammo_type, amount: 999 });
    }
  }
  // Удаляем дубликаты ammo
  const ammoMap = {};
  for (const a of ammo) {
    ammoMap[a.name] = a;
  }
  ammo = Object.values(ammoMap);

  // Выбираем скин
  const classCode = CLASS_CODE_MAP[selectedClass]; // 'R','M','E','S'
  const possibleSkins = allSkins.filter(s => s.classes.includes(classCode));
  let chosenSkin = "default_skin_unknown";
  if (possibleSkins.length > 0) {
    const idx = Math.floor(Math.random() * possibleSkins.length);
    chosenSkin = possibleSkins[idx].name;
  }

  // armor
  const finalArmor = [...DEFAULT_ARMOR];
  finalArmor.push({ name: chosenSkin });

  return {
    armor: finalArmor,
    items: chosenWeapons.map(w => ({ name: w.name, skin: "" })),
    attachments,
    ammo
  };
}

/* =========== 7) Форматирование в Lua =========== */
function formatLua(inventory) {
  const armorStr = inventory.armor.map(a => `      {name = "${a.name}"}`).join(",\n");
  const itemsStr = inventory.items.map(i => `      {name = "${i.name}", skin = "${i.skin}"}`).join(",\n");
  const attachmentsStr = inventory.attachments.map(a => `      {name = "${a.name}", attachTo = "${a.attachTo}"}`).join(",\n");
  const ammoStr = inventory.ammo.map(a => `      {name = "${a.name}", amount = ${a.amount}}`).join(",\n");

  return `
local inventory = {
  armor = 
  {
${armorStr}
  },
  items = 
  {
${itemsStr}
  },
  attachments = 
  {
${attachmentsStr}
  },
  ammo = 
  {
${ammoStr}
  }
}
return inventory
`.trim();
}

/* =========== 8) Запуск после загрузки страницы =========== */
window.addEventListener("DOMContentLoaded", async () => {
  const loadingBlock = document.getElementById("loadingBlock");
  const mainUI = document.getElementById("mainUI");
  const classSelect = document.getElementById("classSelect");
  const resultArea = document.getElementById("resultArea");
  const generateBtn = document.getElementById("generateBtn");
  const copyBtn = document.getElementById("copyBtn");
  const downloadBtn = document.getElementById("downloadBtn");

  try {
    // Загружаем все JSON-списки + XML-файлы
    await loadAllData();

    // Прячем "Загружаем..."
    loadingBlock.classList.add("hidden");
    mainUI.classList.remove("hidden");

    // Нажатие "Сгенерировать"
    generateBtn.addEventListener("click", () => {
      const selectedClass = classSelect.value;
      const inventory = generatePreset(selectedClass);
      if (!inventory) {
        resultArea.value = "Не удалось сгенерировать пресет!";
        return;
      }
      resultArea.value = formatLua(inventory);
    });

    // "Скопировать"
    copyBtn.addEventListener("click", () => {
      if (!resultArea.value) return;
      navigator.clipboard.writeText(resultArea.value)
        .then(() => alert("Скопировано!"))
        .catch(err => console.error(err));
    });

    // "Скачать"
    downloadBtn.addEventListener("click", () => {
      if (!resultArea.value) return;
      const blob = new Blob([resultArea.value], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "preset.lua";
      link.click();
      URL.revokeObjectURL(url);
    });

  } catch (err) {
    loadingBlock.textContent = "Ошибка: " + err.message;
    console.error(err);
  }
});
</script>

</body>
</html>
